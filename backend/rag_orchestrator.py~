from typing import Dict, List

from .agents import (
    retrieval_agent,
    reranker_agent,
    summarizer_agent,
    compliance_reasoner_agent,
    fact_checker_agent,
    answer_writer_agent,
    retriever_agent_logger,
    pipeline_logger,
)

from .evaluation import (
    run_ragas_evaluation
)

# ----------------------------------------------------
# MAIN PIPELINE ENTRYPOINT
# ----------------------------------------------------
def answer_query(query: str) -> Dict:
    pipeline_logger.info(f"Starting full RAG pipeline for query='{query}'")

    # 1 — Retrieve relevant document chunks
    retrieved = retrieval_agent(query, top_k=5)

    # 2 — Rerank for relevance
    reranked = reranker_agent(query, retrieved)

    # 3 — Summarize the top chunks
    summary = summarizer_agent(reranked)

    # 4 — Compliance reasoning
    reasoning = compliance_reasoner_agent(query, summary)

    # 5 — Fact checking
    fact_check_verdict, sources = fact_checker_agent(query, reasoning, reranked)

    # 6 — Final synthesised answer
    answer = answer_writer_agent(query, reranked, reasoning, fact_check_verdict)

    # 7 — Build RAGAS dataset
    #build_ragas_dataset(
     #   question=query,
      #  answer=answer,
       # contexts=reranked,
    #)

    # 8 — Run RAGAS evaluation
    try:
        ragas_scores = run_ragas_evaluation()
    except Exception as e:
        ragas_scores = {"error": str(e)}

    pipeline_logger.info("RAG pipeline complete")

    return {
        "answer": answer,
        "contexts": reranked,
        "reasoning": reasoning,
        "fact_check": fact_check_verdict,
        "sources": sources,
        "ragas_scores": ragas_scores,
    }
