import os
import requests
import streamlit as st
import pandas as pd


# API URL (loaded from .env or default fallback)
API_URL = os.getenv("API_URL", "http://3.20.47.220:8000")


# --------------------------------------------------------------
# STREAMLIT PAGE CONFIGURATION
# --------------------------------------------------------------
st.set_page_config(
    page_title="Enterprise Policy & Compliance Assistant ‚Äî Multi-Agent RAG System",
    layout="wide",
)

st.title("Enterprise Policy & Compliance Assistant ‚Äî Multi-Agent RAG System")
st.caption("Built by Akeem Asiru")


# --------------------------------------------------------------
# SIDEBAR ‚Äî HEALTH + INGEST
# --------------------------------------------------------------
with st.sidebar:
    st.header("Backend Status")

    # Health check
    try:
        health = requests.get(f"{API_URL}/health", timeout=5).json().get("status")
    except:
        health = "unreachable"

    st.metric("API Health", health)

    # Trigger ingestion
    st.subheader("Document Ingestion")

    if st.button("Trigger Ingestion"):
        with st.spinner("Ingesting documents from /data/raw ..."):
            resp = requests.post(f"{API_URL}/ingest", json={})
        st.write(resp.json())


# --------------------------------------------------------------
# TABS LAYOUT
# --------------------------------------------------------------
tab1, tab2, tab3 = st.tabs([
    "üîé Ask Compliance Question",
    "üìä RAG Evaluation",
    "üìà System Metrics",
])


# --------------------------------------------------------------
# TAB 1 ‚Äî RAG Query Interface
# --------------------------------------------------------------
with tab1:
    st.subheader("Ask a Compliance or Policy Question")

    query = st.text_area("Enter your question", height=140)

    if st.button("Run Query", key="run_query"):
        if not query.strip():
            st.warning("Please enter a question.")
        else:
            with st.spinner("Querying multi-agent RAG backend..."):
                try:
                    resp = requests.post(f"{API_URL}/query", json={"query": query})
                except Exception as e:
                    st.error(f"Communication error: {e}")
                    st.stop()

            if resp.status_code != 200:
                st.error("Error communicating with backend.")
            else:
                data = resp.json()

                # Display Answer
                st.markdown("### ‚úÖ Final Answer")
                st.write(data.get("answer", ""))

                # Expanders
                with st.expander("Internal Reasoning"):
                    st.write(data.get("reasoning", ""))

                with st.expander("Fact Check Verdict"):
                    st.write(data.get("fact_check", ""))

                with st.expander("Retrieved Policy Contexts"):
                    for c in data.get("contexts", []):
                        st.markdown(
                            f"**Source:** {c.get('source')} ‚Äî Chunk {c.get('chunk_id')}"
                        )
                        st.write(c.get("text", ""))
                        st.markdown("---")

                with st.expander("Raw RAGAS Evaluation Output"):
                    st.json(data.get("ragas_scores", {}))



# --------------------------------------------------------------
# TAB 2 ‚Äî RAG Evaluation Visualization (Redesigned)
# --------------------------------------------------------------
with tab2:
    st.subheader("üìä RAG Evaluation Dashboard ‚Äî RAGAS Metrics")

    st.markdown("""
        <style>
            .kpi-card {
                background-color: #f7f9fc;
                padding: 18px 20px;
                border-radius: 12px;
                border: 1px solid #e5eaf2;
                box-shadow: 0px 2px 6px rgba(0,0,0,0.05);
                text-align: center;
                margin-bottom: 10px;
            }
            .kpi-value {
                font-size: 28px;
                font-weight: 900;
                color: #2c6bed;
            }
            .kpi-label {
                font-size: 15px;
                font-weight: 600;
                color: #222;
            }
            .banner {
                font-size: 22px;
                font-weight: 800;
                padding: 12px;
                text-align: center;
                border-radius: 10px;
                background-color: #eef5ff;
                color: #1d3fa3;
                border: 1px solid #bcd3ff;
                margin-bottom: 15px;
            }
        </style>
    """, unsafe_allow_html=True)

    # Trigger RAGAS recalculation
    if st.button("üîÑ Refresh RAGAS Scores"):
        with st.spinner("Re-evaluating RAG performance..."):
            try:
                req = {"query": "Test evaluation ping"}
                ragas_resp = requests.post(f"{API_URL}/query", json=req).json()
                scores = ragas_resp.get("ragas_scores", {})
            except:
                scores = {}

    # Always attempt to load latest results
    try:
        ping = requests.post(f"{API_URL}/query", json={"query": "metrics check"}).json()
        scores = ping.get("ragas_scores", {})
    except:
        scores = {}

    # Show redesigned metrics
    if "answer_relevancy" in scores:
        # Composite Score Banner
        composite = scores.get("composite_score", 0)

        st.markdown(
            f"""
            <div class="banner">
                ‚≠ê Composite RAGAS Score: <strong>{composite:.3f}</strong>
            </div>
            """,
            unsafe_allow_html=True,
        )

        # KPI CARDS
        c1, c2, c3, c4 = st.columns(4)

        with c1:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-value">{scores['answer_relevancy']:.3f}</div>
                    <div class="kpi-label">Answer Relevancy</div>
                </div>
                """, unsafe_allow_html=True)

        with c2:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-value">{scores['faithfulness']:.3f}</div>
                    <div class="kpi-label">Faithfulness</div>
                </div>
                """, unsafe_allow_html=True)

        with c3:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-value">{scores['context_precision']:.3f}</div>
                    <div class="kpi-label">Context Precision</div>
                </div>
                """, unsafe_allow_html=True)

        with c4:
            st.markdown(
                f"""
                <div class="kpi-card">
                    <div class="kpi-value">{scores['context_recall']:.3f}</div>
                    <div class="kpi-label">Context Recall</div>
                </div>
                """, unsafe_allow_html=True)

        # Bar Chart Visualization
        df = pd.DataFrame({
            "metric": list(scores.keys()),
            "score": list(scores.values()),
        })

        st.markdown("### üìà Performance Breakdown")
        st.bar_chart(df.set_index("metric"))

        # Raw JSON Viewer
        with st.expander("üìÑ Raw RAGAS JSON Output"):
            st.json(scores)

    else:
        st.info("Run at least one query ‚Äî RAGAS metrics will appear here.")


# --------------------------------------------------------------
# TAB 3 ‚Äî SYSTEM METRICS (for KPIs)
# --------------------------------------------------------------
with tab3:
    st.subheader("System Metrics & Operational Stats")

    try:
        metrics = requests.get(f"{API_URL}/stats").json()
    except:
        metrics = {}

    c1, c2, c3, c4 = st.columns(4)

    c1.metric("Documents Ingested", metrics.get("documents_ingested", "‚Äî"))
    c2.metric("Chunks Ingested", metrics.get("chunks_ingested", "‚Äî"))
    c3.metric("Average Latency (s)", metrics.get("avg_latency", "‚Äî"))
    c4.metric("RAGAS Score (Latest)", metrics.get("ragas_score", "‚Äî"))

    with st.expander("Recent Queries Log"):
        try:
            logs = requests.get(f"{API_URL}/recent-queries").json()
            st.dataframe(logs)
        except:
            st.write("Logs unavailable.")
